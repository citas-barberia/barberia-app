<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Agendar Cita - {{ nombre_barbero }}</title>
    
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { 
            background: #0f0f10; 
            color: #f5f5f5; 
            margin: 0; 
            padding: 15px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 480px;
            background: #1b1b1c;
            padding: 25px;
            border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            margin-top: 10px;
        }

        h1 { 
            color: #D4AF37; 
            text-align: center; 
            font-size: 26px; 
            margin-bottom: 25px;
            line-height: 1.3;
        }

        .form-group { margin-bottom: 18px; }

        label { 
            display: block; 
            margin-bottom: 8px; 
            font-size: 14px; 
            color: #D4AF37;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 16px;
            background: #242425;
            border: 1px solid #333;
            border-radius: 14px;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: 0.3s;
        }

        input:focus, select:focus {
            border-color: #D4AF37;
            background: #2a2a2b;
        }

        button.btn-principal {
            width: 100%;
            padding: 18px;
            background: #D4AF37;
            color: #000;
            border: none;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button.btn-principal:active { transform: scale(0.96); }

        /* âœ… BOTÃ“N WHATSAPP */
        .btn-whatsapp {
            display: block;
            width: 100%;
            text-align: center;
            background: #25D366;
            color: #fff;
            text-decoration: none;
            padding: 14px;
            border-radius: 12px;
            font-weight: bold;
            margin-top: 12px;
        }

        .tus-citas {
            margin-top: 40px;
            border-top: 1px solid #333;
            padding-top: 20px;
        }

        .cita-card {
            background: #242425;
            padding: 18px;
            border-radius: 16px;
            margin-bottom: 15px;
            border-left: 5px solid #D4AF37;
            position: relative;
        }

        .cita-card strong { color: #D4AF37; font-size: 17px; display: block; margin-bottom: 5px; }
        .cita-card span { display: block; font-size: 14px; opacity: 0.8; margin-bottom: 3px; }

        .btn-cancelar {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 10px;
            cursor: pointer;
        }

        .flash {
            background: #D4AF37;
            color: #000;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Agenda tu cita con<br>{{ nombre_barbero }} ðŸ’ˆ</h1>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="flash">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form action="/" method="POST">
        <input type="hidden" name="cliente_id" value="{{ cliente_id }}">
        <input type="hidden" name="barbero" value="{{ nombre_barbero }}">

        <div class="form-group">
            <label>Tu Nombre:</label>
            <input type="text" name="cliente" placeholder="Escribe tu nombre completo" required>
        </div>

        <div class="form-group">
            <label>Servicio:</label>
            <select name="servicio" required>
                <option value="" disabled selected>Â¿QuÃ© servicio buscas?</option>
                {% for nombre, precio in servicios.items() %}
                <option value="{{ nombre }}">{{ nombre }} - â‚¡{{ precio }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Fecha:</label>
            <input
                type="date"
                id="fecha"
                name="fecha"
                value="{{ hoy_iso }}"
                min="{{ hoy_iso }}"
                required
                onchange="actualizarHoras()">
        </div>

        <div class="form-group">
            <label>Hora disponible:</label>
            <select name="hora" id="hora_select" required>
                <option value="">Primero elige una fecha...</option>
            </select>
        </div>

        <button type="submit" class="btn-principal">Reservar Espacio</button>

        <!-- âœ… BOTÃ“N WHATSAPP -->
        <a class="btn-whatsapp"
           href="https://wa.me/{{ numero_barbero }}?text=Hola%20tengo%20una%20consulta%20sobre%20la%20barber%C3%ADa"
           target="_blank">
           ðŸ’¬ Consultar por WhatsApp
        </a>
    </form>

    <div class="tus-citas">
        <h2 style="text-align: center; color: #fff; font-size: 20px;">Mis Citas Agendadas</h2>

        {% for c in citas %}
        <div class="cita-card">
            <strong>{{ c.servicio }}</strong>
            <span>ðŸ“… Fecha: {{ c.fecha }}</span>
            <span>ðŸ•’ Hora: {{ c.hora }}</span>
            <span>ðŸ’° Precio: {{ c.precio }}</span>
            
            {% if c.servicio != "CITA CANCELADA" and c.servicio != "CITA ATENDIDA" and c.fecha >= hoy_iso %}
            <form action="/cancelar" method="POST">
                <input type="hidden" name="id" value="{{ c.id }}">
                <button type="submit" class="btn-cancelar" onclick="return confirm('Â¿Seguro que quieres cancelar?')">Cancelar Cita</button>
            </form>
            {% endif %}
        </div>
        {% else %}
        <p style="text-align: center; opacity: 0.5;">AÃºn no tienes citas.</p>
        {% endfor %}
    </div>
</div>

<script>
async function actualizarHoras() {
    const fecha = document.getElementById('fecha').value;
    const barbero = "{{ nombre_barbero }}";
    const select = document.getElementById('hora_select');
    
    select.innerHTML = '<option value="">Cargando horas...</option>';

    try {
        const res = await fetch(`/horas?fecha=${fecha}&barbero=${barbero}&t=${Date.now()}`);
        const horas = await res.json();

        select.innerHTML = '';

        if (horas.length === 0) {
            select.innerHTML = '<option value="">No hay horas disponibles</option>';
        } else {
            select.innerHTML = '<option value="" disabled selected>Selecciona la hora</option>';
            horas.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.textContent = h;
                select.appendChild(opt);
            });
        }
    } catch (e) {
        select.innerHTML = '<option value="">Error al cargar</option>';
    }
}

window.onload = actualizarHoras;
</script>

</body>
</html>


