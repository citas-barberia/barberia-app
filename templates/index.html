<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agendar Cita - BarberÃ­a</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
body { background: #121212; color: #f0f0f0; }
.container { max-width: 800px; margin: 40px auto; background: #1f1f1f; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
h1 { text-align: center; font-size: 2.5rem; margin-bottom: 30px; color: #D4AF37; text-shadow: 1px 1px 3px #000; }
h2 { margin-top: 40px; margin-bottom: 20px; color: #ccc; text-align: center; }
form { display: flex; flex-direction: column; gap: 20px; }
input, select, button { padding: 15px; font-size: 16px; border-radius: 10px; border: 1px solid #333; outline: none; transition: all 0.3s ease; }
input, select { background: #2b2b2b; color: #f0f0f0; }
input:focus, select:focus { border-color: #D4AF37; box-shadow: 0 0 10px #D4AF37; }
button { background: #D4AF37; color: #121212; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
button:hover { background: #c29d2f; transform: scale(1.03); }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #2b2b2b; border-radius: 10px; overflow: hidden; }
th, td { padding: 12px; text-align: center; }
th { background: #333; color: #D4AF37; font-weight: bold; }
tr:nth-child(even) { background: #262626; }
tr:nth-child(odd) { background: #2b2b2b; }
tr:hover { background: #D4AF3733; }

/* âœ… BOTÃ“N WHATSAPP */
.btn-whatsapp {
    display: inline-block;
    background: #25D366;
    color: #fff;
    text-decoration: none;
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}
.btn-whatsapp:hover { background: #1ebe57; transform: scale(1.05); }

.alert { padding: 12px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-weight: bold; opacity: 0; animation: fadeIn 0.5s forwards, fadeOut 0.5s 2.5s forwards; }
.alert-success { background-color: #28a745; color: #fff; }
.alert-error { background-color: #dc3545; color: #fff; }
@keyframes fadeIn { to { opacity: 1; } }
@keyframes fadeOut { to { opacity: 0; } }

@media (max-width: 520px){
  .container{ margin: 14px; padding: 18px; }
  h1{ font-size: 1.9rem; }
}
</style>

<script>
async function actualizarHoras() {
    const fecha = document.getElementById("fecha").value;
    const barbero = document.getElementById("barbero").value;
    const selectHora = document.getElementById("hora");

    if(!fecha || !barbero) return;

    const res = await fetch(`/horas?fecha=${encodeURIComponent(fecha)}&barbero=${encodeURIComponent(barbero)}&t=${Date.now()}`);
    const horas = await res.json();

    selectHora.innerHTML = "";

    if(horas.length === 0){
        const option = document.createElement("option");
        option.text = "No hay horas disponibles";
        option.value = "";
        selectHora.appendChild(option);
        return;
    }

    horas.forEach(h => {
        const option = document.createElement("option");
        option.value = h;
        option.text = h;
        selectHora.appendChild(option);
    });
}

window.addEventListener("DOMContentLoaded", () => {
    const fechaInput = document.getElementById("fecha");
    const today = new Date();

    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');

    fechaInput.value = `${year}-${month}-${day}`;
    fechaInput.min = `${year}-01-01`;
    fechaInput.max = `${year}-12-31`;

    actualizarHoras();
});
</script>

</head>

<body>
<div class="container">

<h1>Agenda tu cita con {{ nombre_barbero }} ðŸ’ˆ</h1>

{% with messages = get_flashed_messages() %}
{% if messages %}
{% for msg in messages %}
<div class="alert {% if 'exitosamente' in msg %}alert-success{% else %}alert-error{% endif %}">
{{ msg }}
</div>
{% endfor %}
{% endif %}
{% endwith %}

<form method="POST">
  <input type="hidden" name="cliente_id" value="{{ cliente_id }}">

  <input type="text" name="cliente" placeholder="Tu nombre" required>

  <!-- âœ… Barbero fijo (Erickson) -->
  <input type="text"
        name="barbero"
        id="barbero"
        value="{{ nombre_barbero }}"
        readonly
        required>

  <!-- âœ… si cambia servicio, recarga horas -->
  <select name="servicio" required onchange="actualizarHoras()">
    <option value="">Seleccione un servicio</option>
    {% for s, p in servicios.items() %}
      <option value="{{ s }}">{{ s }} - â‚¡{{ p }}</option>
    {% endfor %}
  </select>

  <input type="date" id="fecha" name="fecha" onchange="actualizarHoras()" required>

  <!-- âœ… Horas disponibles -->
  <select id="hora" name="hora" required></select>

  <button type="submit">Agendar Cita</button>
</form>

<h2>Tus Citas</h2>

<table>
<tr>
<th>Cliente</th>
<th>Barbero</th>
<th>Servicio</th>
<th>Precio</th>
<th>Fecha</th>
<th>Hora</th>
<th>Cancelar</th>
<th>WhatsApp</th>
</tr>

{% for c in citas %}
<tr>
<td>{{ c.cliente }}</td>
<td>{{ c.barbero }}</td>
<td>{{ c.servicio }}</td>
<td>{{ c.precio }}</td>
<td>{{ c.fecha.split('-')[2] }}/{{ c.fecha.split('-')[1] }}/{{ c.fecha.split('-')[0] }}</td>
<td>{{ c.hora }}</td>

<td>
  <!-- âœ… solo deja cancelar si NO estÃ¡ cancelada y la fecha es hoy o futura -->
  {% if c.servicio != "CITA CANCELADA" and c.fecha >= hoy_iso %}
    <form method="POST" action="{{ url_for('cancelar') }}">
      <input type="hidden" name="id" value="{{ c.id }}">
      <button type="submit">Cancelar</button>
    </form>
  {% endif %}
</td>

<td>
  {% if c.servicio != "CITA CANCELADA" %}
    <a class="btn-whatsapp"
      href="https://wa.me/{{ numero_barbero }}?text=Hola%20vengo%20por%20la%20cita%20de%20la%20barber%C3%ADa"
      target="_blank">
    WhatsApp
    </a>
  {% endif %}
</td>
</tr>
{% endfor %}
</table>

</div>
</body>
</html>


