<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Panel del Barbero</title>

  <!-- ICONOS iPhone / iPad -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">

  <!-- ICONO navegador / PWA -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512.png">

  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#0b0f19">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    /* ‚úÖ Esto ayuda a que en m√≥vil se vea ‚Äúcompleto‚Äù y c√≥modo */
    .box {
      max-width: 1150px;
      margin: 16px auto;
      padding: 16px;
      background: #1f1f1f;
      border-radius: 16px;
    }

    h1 { margin: 0 0 10px; color: #D4AF37; }

    .filters { display: flex; gap: 10px; flex-wrap: wrap; }
    input, select, button { padding: 10px; border-radius: 10px; border: none; }
    input, select { background: #111; color: #f5f5f5; border: 1px solid #333; }
    button { cursor: pointer; background: #D4AF37; color: #111; }

    .small { opacity: .8; font-size: 12px; margin-top: 6px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border-bottom: 1px solid #333; text-align: left; }
    th { color: #D4AF37; }

    .tag { padding: 4px 8px; border-radius: 999px; font-size: 12px; display: inline-block; }
    .ok { background: #28a745; }
    .bad { background: #dc3545; }
    .done { background: #007bff; }
  </style>
</head>
<body>
<div class="box">

<h1>Panel de Erickson üíà</h1>

<!-- ‚úÖ CONTADORES -->
<div class="stats">
  <div class="card">
    <div class="t" id="t_citas">Citas</div>
    <div class="v" id="v_total">{{ stats.cant_total }}</div>
  </div>
  <div class="card"><div class="t">Activas</div><div class="v" id="v_activas">{{ stats.cant_activas }}</div></div>
  <div class="card"><div class="t">Atendidas</div><div class="v" id="v_atendidas">{{ stats.cant_atendidas }}</div></div>
  <div class="card"><div class="t">Canceladas</div><div class="v" id="v_canceladas">{{ stats.cant_canceladas }}</div></div>
  <div class="card"><div class="t">Total cobrado (Atendidas)</div><div class="v money" id="v_total_cobrado">‚Ç°{{ stats.total_atendido }}</div></div>
</div>

<!-- ‚úÖ FILTROS -->
<form class="filters" onsubmit="event.preventDefault(); cargarCitas(true);">
  <select name="solo" id="solo">
    <option value="hoy">Hoy</option>
    <option value="manana">Ma√±ana</option>
    <option value="todas">Todas</option>
  </select>

  <select name="estado" id="estado">
    <option value="activas">Activas</option>
    <option value="atendidas">Atendidas</option>
    <option value="canceladas">Canceladas</option>
    <option value="todas">Todas</option>
  </select>

  <input id="q" placeholder="Buscar cliente/servicio" />
  <button type="submit">Aplicar</button>
</form>

<div class="small" id="last_update">Actualizando‚Ä¶</div>

<!-- ‚úÖ TABLA -->
<table>
<thead>
<tr>
  <th>Fecha</th><th>Hora</th><th>Cliente</th><th>Servicio</th><th>Precio</th><th>Estado</th><th>Acci√≥n</th>
</tr>
</thead>
<tbody id="tbody">
{% for c in citas %}
<tr>
  <td>{{ c.fecha }}</td>
  <td>{{ c.hora }}</td>
  <td>{{ c.cliente }}</td>
  <td>{{ c.servicio }}</td>
  <td>‚Ç°{{ c.precio }}</td>
  <td>
    {% if c.servicio == "CITA CANCELADA" %}
      <span class="tag bad">Cancelada</span>
    {% elif c.servicio == "CITA ATENDIDA" %}
      <span class="tag done">Atendida</span>
    {% else %}
      <span class="tag ok">Activa</span>
    {% endif %}
  </td>
  <td>
    {% if c.servicio not in ["CITA CANCELADA","CITA ATENDIDA"] %}
      <form method="POST" action="/atendida">
        <input type="hidden" name="id" value="{{ c.id }}">
        <button type="submit">Marcar atendida</button>
      </form>
    {% endif %}
  </td>
</tr>
{% endfor %}
</tbody>
</table>

</div>

<script>
function precioAInt(p){
  if(p === null || p === undefined) return 0;
  return parseInt(String(p).replace("‚Ç°","").replaceAll(",","").trim() || "0", 10) || 0;
}

function aplicarFiltros(citas){
  const solo = document.getElementById("solo").value;
  const estado = document.getElementById("estado").value;
  const q = (document.getElementById("q").value || "").trim().toLowerCase();

  const hoy = new Date();
  const yyyy = hoy.getFullYear();
  const mm = String(hoy.getMonth()+1).padStart(2,"0");
  const dd = String(hoy.getDate()).padStart(2,"0");
  const hoyStr = `${yyyy}-${mm}-${dd}`;

  const manana = new Date(hoy);
  manana.setDate(hoy.getDate()+1);
  const my = manana.getFullYear();
  const mmm = String(manana.getMonth()+1).padStart(2,"0");
  const mdd = String(manana.getDate()).padStart(2,"0");
  const mananaStr = `${my}-${mmm}-${mdd}`;

  let base = [...citas];

  // fecha
  if(solo === "hoy") base = base.filter(c => String(c.fecha) === hoyStr);
  if(solo === "manana") base = base.filter(c => String(c.fecha) === mananaStr);

  // estado
  if(estado === "activas") base = base.filter(c => !["CITA CANCELADA","CITA ATENDIDA"].includes(c.servicio));
  if(estado === "canceladas") base = base.filter(c => c.servicio === "CITA CANCELADA");
  if(estado === "atendidas") base = base.filter(c => c.servicio === "CITA ATENDIDA");

  // b√∫squeda
  if(q){
    base = base.filter(c =>
      String(c.cliente||"").toLowerCase().includes(q) ||
      String(c.servicio||"").toLowerCase().includes(q)
    );
  }

  // ordenar
  base.sort((a,b) => {
    const k1 = String(a.fecha).localeCompare(String(b.fecha));
    if(k1 !== 0) return k1;
    return String(a.hora).localeCompare(String(b.hora));
  });

  return { base, hoyStr, mananaStr };
}

function renderTabla(citas){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  citas.forEach(c => {
    const tr = document.createElement("tr");

    const estado = c.servicio === "CITA CANCELADA" ? "Cancelada"
                : c.servicio === "CITA ATENDIDA" ? "Atendida"
                : "Activa";

    const tagClass = c.servicio === "CITA CANCELADA" ? "bad"
                  : c.servicio === "CITA ATENDIDA" ? "done"
                  : "ok";

    tr.innerHTML = `
      <td>${c.fecha}</td>
      <td>${c.hora}</td>
      <td>${c.cliente || ""}</td>
      <td>${c.servicio || ""}</td>
      <td>‚Ç°${c.precio || 0}</td>
      <td><span class="tag ${tagClass}">${estado}</span></td>
      <td>
        ${
          (!["CITA CANCELADA","CITA ATENDIDA"].includes(c.servicio)) ?
          `<form method="POST" action="/atendida">
              <input type="hidden" name="id" value="${c.id}">
              <button type="submit">Marcar atendida</button>
            </form>`
          : ""
        }
      </td>
    `;

    tbody.appendChild(tr);
  });
}

function actualizarStats(citasDia, solo){
  const cant_total = citasDia.length;
  const cant_canceladas = citasDia.filter(c => c.servicio === "CITA CANCELADA").length;
  const cant_atendidas = citasDia.filter(c => c.servicio === "CITA ATENDIDA").length;
  const cant_activas = citasDia.filter(c => !["CITA CANCELADA","CITA ATENDIDA"].includes(c.servicio)).length;
  const total_atendido = citasDia
    .filter(c => c.servicio === "CITA ATENDIDA")
    .reduce((acc, c) => acc + precioAInt(c.precio), 0);

  document.getElementById("v_total").textContent = cant_total;
  document.getElementById("v_activas").textContent = cant_activas;
  document.getElementById("v_atendidas").textContent = cant_atendidas;
  document.getElementById("v_canceladas").textContent = cant_canceladas;
  document.getElementById("v_total_cobrado").textContent = "‚Ç°" + total_atendido;

  const t = solo === "hoy" ? "Citas (Hoy)"
        : solo === "manana" ? "Citas (Ma√±ana)"
        : "Citas (Todas)";
  document.getElementById("t_citas").textContent = t;
}

async function cargarCitas(guardarParams=false){
  try{
    const res = await fetch(`/citas_json?t=${Date.now()}`);
    const data = await res.json();
    const citas = data.citas || [];

    const solo = document.getElementById("solo").value;
    const { base, hoyStr, mananaStr } = aplicarFiltros(citas);

    // stats del ‚Äúd√≠a‚Äù seg√∫n solo (hoy/ma√±ana/todas)
    let citasDia = [...citas];
    if(solo === "hoy") citasDia = citas.filter(c => String(c.fecha) === hoyStr);
    if(solo === "manana") citasDia = citas.filter(c => String(c.fecha) === mananaStr);

    actualizarStats(citasDia, solo);
    renderTabla(base);

    document.getElementById("last_update").textContent = "√öltima actualizaci√≥n: " + new Date().toLocaleTimeString();

    if(guardarParams){
      const params = new URLSearchParams(window.location.search);
      params.set("solo", document.getElementById("solo").value);
      params.set("estado", document.getElementById("estado").value);
      params.set("q", document.getElementById("q").value || "");
      history.replaceState(null, "", `${window.location.pathname}?${params.toString()}`);
    }
  }catch(e){
    document.getElementById("last_update").textContent = "No se pudo actualizar (revisa internet).";
  }
}

// ‚úÖ cargar filtros desde URL al abrir
(function(){
  const params = new URLSearchParams(window.location.search);
  const solo = params.get("solo");
  const estado = params.get("estado");
  const q = params.get("q");
  if(solo) document.getElementById("solo").value = solo;
  if(estado) document.getElementById("estado").value = estado;
  if(q) document.getElementById("q").value = q;
})();

// ‚úÖ primera carga + auto refresh
cargarCitas(false);
setInterval(() => cargarCitas(false), 5000);
</script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/static/service-worker.js");
    });
  }
</script>
</body>
</html>


