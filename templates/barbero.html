<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Panel del Barbero</title>

  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">
  <link rel="manifest" href="/static/manifest.json">
  
  <meta name="theme-color" content="#0b0f19">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: #0f0f10;
      color: #f5f5f5;
      font-family: 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
    }

    .box {
      width: calc(100% - 20px);
      max-width: 1200px;
      margin: 10px auto;
      padding: 16px;
      background: #1b1b1c;
      border-radius: 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
    }

    h1 {
      margin: 0 0 14px;
      color: #D4AF37;
      font-size: 36px;
      line-height: 1.1;
      text-align: center;
    }

    /* STATS RESPONSIVAS */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .card {
      background: #242425;
      border: 1px solid #2e2e2f;
      border-radius: 16px;
      padding: 14px;
      text-align: center;
    }

    .t { opacity: .85; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    .v { font-size: 24px; margin-top: 5px; font-weight: 700; }
    .money { color: #28a745; }

    /* FILTROS */
    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    input, select {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      border-radius: 12px;
      background: #121213;
      color: #fff;
      border: 1px solid #2f2f30;
      font-size: 14px;
    }

    button {
      padding: 12px 20px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #D4AF37;
      color: #111;
      font-weight: 700;
      transition: 0.3s;
    }

    button:active { transform: scale(0.98); }

    .small { opacity: .6; font-size: 12px; text-align: center; margin-bottom: 15px; }

    /* --- DISEÃ‘O DE TARJETAS (MOVIL) --- */
    .citas-mobile-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .cita-item {
      background: #242425;
      border: 1px solid #2e2e2f;
      border-radius: 16px;
      padding: 16px;
    }

    .cita-row-main {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .cli-name { font-size: 18px; font-weight: 700; color: #D4AF37; }
    .cli-serv { font-size: 15px; color: #ccc; margin: 4px 0; }
    .cli-meta { font-size: 13px; opacity: 0.7; display: flex; gap: 10px; }

    .btn-atender-mobile {
      width: 100%;
      margin-top: 12px;
      background: #D4AF37;
      color: #111;
      font-size: 15px;
      text-transform: uppercase;
    }

    /* --- TABLA (PC) --- */
    .table-wrap {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid #2f2f30;
      display: none; /* Se oculta por defecto, se muestra en pantallas grandes */
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px; text-align: left; border-bottom: 1px solid #2a2a2b; }
    th { color: #D4AF37; background: #1a1a1b; font-size: 13px; }

    .tag {
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
    }
    .ok { background: #28a745; color: #fff; }
    .bad { background: #dc3545; color: #fff; }
    .done { background: #007bff; color: #fff; }

    /* RESPONSIVIDAD LOGICA */
    @media (min-width: 800px) {
      .table-wrap { display: block; }
      .citas-mobile-container { display: none; }
      h1 { text-align: left; font-size: 42px; }
    }
  </style>
</head>

<body>
  <div class="box">
    <h1>Panel de {{ stats.get('nombre', 'Erickson') }} ðŸ’ˆ</h1>

    <div class="stats">
      <div class="card">
        <div class="t" id="t_citas">Citas</div>
        <div class="v" id="v_total">{{ stats.cant_total }}</div>
      </div>
      <div class="card">
        <div class="t">Activas</div>
        <div class="v" id="v_activas">{{ stats.cant_activas }}</div>
      </div>
      <div class="card">
        <div class="t">Atendidas</div>
        <div class="v" id="v_atendidas">{{ stats.cant_atendidas }}</div>
      </div>
      <div class="card">
        <div class="t">Total Cobrado</div>
        <div class="v money" id="v_total_cobrado">â‚¡{{ stats.total_atendido }}</div>
      </div>
    </div>

    <form class="filters" onsubmit="event.preventDefault(); cargarCitas(true);">
      <select id="solo">
        <option value="hoy">Hoy</option>
        <option value="manana">MaÃ±ana</option>
        <option value="todas">Todas</option>
      </select>
      <select id="estado">
        <option value="activas">Activas</option>
        <option value="atendidas">Atendidas</option>
        <option value="canceladas">Canceladas</option>
        <option value="todas">Todas</option>
      </select>
      <input id="q" placeholder="Buscar cliente..." />
      <button type="submit">Aplicar</button>
    </form>

    <div class="small" id="last_update">Actualizandoâ€¦</div>

    <div id="cards-container" class="citas-mobile-container"></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>Hora</th><th>Cliente</th><th>Servicio</th><th>Precio</th><th>Estado</th><th>AcciÃ³n</th>
          </tr>
        </thead>
        <tbody id="tbody">
            </tbody>
      </table>
    </div>
  </div>

<script>
// --- LOGICA DE DATOS ---
function precioAInt(p){
  return parseInt(String(p||"0").replace("â‚¡","").replaceAll(",","").trim()) || 0;
}

function renderCitas(citas) {
  const tbody = document.getElementById("tbody");
  const cardsContainer = document.getElementById("cards-container");
  
  tbody.innerHTML = "";
  cardsContainer.innerHTML = "";

  citas.forEach(c => {
    const esActiva = !["CITA CANCELADA","CITA ATENDIDA"].includes(c.servicio);
    const estadoTxt = c.servicio === "CITA CANCELADA" ? "Cancelada" : (c.servicio === "CITA ATENDIDA" ? "Atendida" : "Activa");
    const tagClass = c.servicio === "CITA CANCELADA" ? "bad" : (c.servicio === "CITA ATENDIDA" ? "done" : "ok");

    // RENDER TABLA (PC)
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.fecha}</td><td>${c.hora}</td><td>${c.cliente}</td>
      <td>${c.servicio}</td><td>â‚¡${c.precio}</td>
      <td><span class="tag ${tagClass}">${estadoTxt}</span></td>
      <td>${esActiva ? `<form method="POST" action="/atendida"><input type="hidden" name="id" value="${c.id}"><button type="submit">Atender</button></form>` : ''}</td>
    `;
    tbody.appendChild(tr);

    // RENDER TARJETAS (MOVIL)
    const card = document.createElement("div");
    card.className = "cita-item";
    card.innerHTML = `
      <div class="cita-row-main">
        <div>
          <div class="cli-name">${c.cliente}</div>
          <div class="cli-serv">${c.servicio}</div>
          <div class="cli-meta">
            <span>ðŸ•’ ${c.hora}</span>
            <span>ðŸ’° â‚¡${c.precio}</span>
          </div>
        </div>
        <span class="tag ${tagClass}">${estadoTxt}</span>
      </div>
      ${esActiva ? `
        <form method="POST" action="/atendida">
          <input type="hidden" name="id" value="${c.id}">
          <button type="submit" class="btn-atender-mobile">Marcar Atendida</button>
        </form>` : ''}
    `;
    cardsContainer.appendChild(card);
  });
}

// --- FILTROS Y FETCH ---
async function cargarCitas(guardarParams=false){
  try{
    const res = await fetch(`/citas_json?t=${Date.now()}`);
    const data = await res.json();
    const citas = data.citas || [];

    // Aplicar filtros locales (reutilizando tu lÃ³gica)
    const solo = document.getElementById("solo").value;
    const estado = document.getElementById("estado").value;
    const q = (document.getElementById("q").value || "").toLowerCase();

    const hoyStr = new Date().toISOString().split('T')[0];
    
    let filtradas = citas.filter(c => {
        let matchSolo = true;
        if(solo === "hoy") matchSolo = c.fecha === hoyStr;
        
        let matchEstado = true;
        if(estado === "activas") matchEstado = !["CITA CANCELADA","CITA ATENDIDA"].includes(c.servicio);
        if(estado === "atendidas") matchEstado = c.servicio === "CITA ATENDIDA";
        if(estado === "canceladas") matchEstado = c.servicio === "CITA CANCELADA";

        let matchQ = c.cliente.toLowerCase().includes(q) || c.servicio.toLowerCase().includes(q);
        
        return matchSolo && matchEstado && matchQ;
    });

    renderCitas(filtradas);
    document.getElementById("last_update").textContent = "Ãšltima actualizaciÃ³n: " + new Date().toLocaleTimeString();
  } catch(e) { console.error(e); }
}

setInterval(() => cargarCitas(false), 5000);
cargarCitas(false);
</script>
</body>
</html>

